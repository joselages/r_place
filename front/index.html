<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R_Place</title>
    <style>
        canvas {
            outline: 5px solid rgb(197, 197, 197);
            width: 800px;
            height: 800px;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            margin: 10px;
        }

        .colors{
            display: flex;
            gap:10px
        }

        .colors span{
            height: 25px;
            width: 25px;
            background-color: var(--color);
            cursor: pointer;
        }

        .colors span.-active{
            transform:scale(1.2);
            box-shadow: 0 0 2px grey;
        }

        .pixel_info{
            position: fixed;
            padding: 10px;
            background: #000;
            color:white;
            transform: translateY(-40px);
            display: none;
        }
    </style>
</head>

<body>
    <header>
        <nav>
            <button class="js-logoutBtn">Logout</button>
            <a href="/login" class="js-loginBtn">Login</a>
        </nav>
    </header>
    <canvas id="myCanvas" width="50" height="50"></canvas>
    <div>
        <label for="picker">Pick your color:</label>
        <input type="color" id="color" name="picker">
    </div>

    <div class="pixel_info js-pixelInfo">
        ola
    </div>


    <script src="/socket.io/socket.io.js"></script>

    <script>
        var socket = io();

        const logoutBtn = document.querySelector('.js-logoutBtn');
        const loginBtn = document.querySelector('.js-loginBtn');
        const isLogged = localStorage.getItem('rPlaceLoginJWT');
        
        if(!isLogged){
            logoutBtn.remove();
        } else {
            loginBtn.remove();
        }

        logoutBtn.addEventListener('click', () => {

           if( !isLogged ){
               return;
           }

           localStorage.removeItem('rPlaceLoginJWT');
           localStorage.removeItem('rPlaceUserName');
           window.location = '/';        
        });

        async function getPixels(){
            const request = await fetch('/pixels',{
                method: 'GET',
                headers: {"Content-Type": "application/json"}
            });

            const response = await request.json();

            return response;
        }

        let pixels;
        document.addEventListener('DOMContentLoaded', async () => {

            pixels = await getPixels();
            
            for(pixel of pixels){
                paintCanvas(pixel);
            }

        })

        const canvas = document.getElementById('myCanvas');
        const ctx = canvas.getContext('2d');

        function paintCanvas(pixel){
            ctx.fillStyle = pixel.color;
            ctx.fillRect(pixel.x, pixel.y, 1, 1);
        }


        const canvasZoomSize = canvas.clientHeight;
        const canvasRealSize = Number(canvas.attributes.width.value);
        function convertPos(x, y) {
            const realX = Math.floor(canvasRealSize * x / canvasZoomSize);
            const realY = Math.floor(canvasRealSize * y / canvasZoomSize);
            return { x: realX, y: realY };
        }

        const pixelInfo = document.querySelector('.js-pixelInfo');
        canvas.addEventListener('mousemove', (evt) => {
            const x = evt.pageX - evt.target.offsetLeft;
            const y = evt.pageY - evt.target.offsetTop;
            const realPos = convertPos(x, y);
            
            const foundPixel = pixels.find(pix => pix.x === realPos.x && pix.y === realPos.y)

            if(
                foundPixel === undefined
            ){
                pixelInfo.style.display = 'none';
                return
            }

            pixelInfo.innerHTML = `by ${foundPixel.user_id.username}<br>at ${makeDateReadable(foundPixel.created_at)}`
            pixelInfo.style.top = y + 'px';
            pixelInfo.style.left = x + 'px';
            pixelInfo.style.display = 'block';
        });

        function makeDateReadable(date){
            date = new Date(date);

            return `${date.getHours()}:${date.getMinutes()} ${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`

        }

        canvas.addEventListener('mouseleave', () => pixelInfo.style.display = 'none');

        canvas.addEventListener('click', async (evt) => {
            const x = evt.pageX - evt.target.offsetLeft;
            const y = evt.pageY - evt.target.offsetTop;
            const realPos = convertPos(x, y);
            
            let data = {
                "x":realPos.x,
                "y":realPos.y,
                "color": pickedColor
            }
            
            const request = await fetch('/pixels',{
                method: 'POST',
                headers: {
                    "Content-Type": "application/json",
                    "X-Auth-Token": localStorage.getItem('rPlaceLoginJWT')
                },
                body:JSON.stringify(data)
            });
            
            const response = await request.json();
            
            if(request.status !== 202){
                console.error('Something went wrong, please try again later');
                return;
            }
            
            data['created_at'] = new Date;
            data['user_id'] = {'username':localStorage.getItem('rPlaceUserName')}

            paintCanvas(data);
            socket.emit('pixel', data);
        });

        function updatePixel(data) {

            let existingPixel = -1;

            for(px in pixels){
                if(
                    pixels[px].x === data.x &&
                    pixels[px].y === data.y
                ){
                    existingPixel = px;
                    break;
                }   
            }

            if(existingPixel < 0){
                pixels.push(data)
            } else {
                pixels[existingPixel] = data;
            }
        }

        socket.on('pixel', (data) => {
            updatePixel(data);
            paintCanvas(data);
        });

        const colorPicker = document.querySelector('#color');
        let pickedColor = '#000000';
        colorPicker.addEventListener('change', (evt) => {
            pickedColor = evt.target.value;
        });
    </script>
</body>

</html>