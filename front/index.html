<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üñçÔ∏è</text></svg>">
    <title>R_Place</title>
    <style>
        :root{
            --canvasSize: 800px;
        }

        html{
            height: 100vh;
            height: calc(var(--vh, 1vh) * 100);
        }

        body{
            display: grid;
            grid-template-rows: min-content auto;
        }

        header{
            height: fit-content;
            position: relative;
            z-index: 10;
        }

        canvas {
            width: var(--canvasSize);
            aspect-ratio: 1;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background-color: white;
        }

        .colors{
            display: flex;
            gap:10px;
        }

        .color{
            height: 25px;
            width: 25px;
            background-color: var(--colorBg);
            cursor: pointer;
            border: 1px solid rgb(191, 196, 204);
            transition: transform .1s ease;
        }

        .color.-active{
            transform:scale(1.2);
            box-shadow: 0 0 #0000,  0 0 #0000, 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .pixel_info{
            position: fixed;
            padding: 10px;
            transform: translateX(-50%) translateY(-130%);
            display: none;
            z-index: 999999;
        }

        .pixel_info::before{
            content: '';
            width: 15px;
            height: 15px;
            position: absolute;
            bottom: -7px;
            left: 50%;
            background-color: #1e293b;
            transform: translateX(-50%) rotate(45deg);
        }

        .message_overlay{
            position: fixed;
            inset: -1px;
            display: grid;
            place-items: center;
            background: rgba(8, 8, 8, 0.65);
        }

        .message{
            padding:40px 80px;
            background-color: white;
            display: flex;
            flex-direction: column;
            gap:15px
        }

        .info-window{
            position: fixed;
            top:calc(var(--headerHeight) - 1px );
            left:0;
            width: 250px;
            bottom:0;
            padding:16px;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            z-index: 9;
            transition:transform .1s ease;
        }

        .info-window.-close{
            transform: translateX(-100%);
        }

        .info_box{
            height: 50%;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }

        @media (max-width: 800px){
            main, .game-container{
                height: calc(calc(var(--vh, 1vh) * 100) - var(--headerHeight));
            }
            .canvas-container{
                width: 100%;
                overflow: auto;
                border-top: none !important;
            }
        }

        @media (max-width: 550px){
            .welcome-msg{
                display: none;
            }
        }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 h-screen font-['Arial'] text-slate-600 overflow-x-hidden">
    <header class="header flex justify-between items-baseline py-2 px-4 bg-slate-200">

        <button class="js-hideMenu text-xs font-bold p-1 text-blue-500/70 hover:opacity-75">
            &lt; hide menu
        </button>
        <button class="js-openMenu text-xs hidden font-bold p-1 text-blue-500/70 hover:opacity-75">
            &gt; show menu
        </button>
        
        <nav>
            <span class="js-welcomeMsg welcome-msg mr-8"></span>
            <button class="js-logoutBtn bg-transparent text-blue-500 font font-semibold hover:opacity-50 py-1 px-2 border border-blue-500 rounded">Logout</button>
            <a href="/login" class="js-loginBtn text-blue-500 font-semibold hover:underline">Login</a>
        </nav>
    </header>
    <aside class="info-window js-sideMenu bg-white/[.98] border-r-4 border-slate-200">
        <h1 class="text-2xl font-bold text-blue-500 mb-1">Welcome<br>to R_Place!<span class="text-md">üñçÔ∏è</span></h1>
        <p>If you didn't notice yet, this is a <a class="font-semibold underline text-blue-500 hover:opacity-75" href="https://reddit.fandom.com/wiki/Place" target="_blank">r/place</a> knock-off, but much smaller and way shittier...<br>Login and have fun!</p>

        <span class="js-userCount font-medium mt-8">Loading...</span>
        <div class="js-infoWindow info_box my-2 p-2 bg-white border border-slate-200 rounded">
        </div>

        <div class="mt-auto ml-auto">
            <ul>
                <li>
                    <a class="hover:opacity-75"  href="https://github.com/joselages/r_place" target="_blank" >
                        <svg height="32" aria-hidden="true" viewBox="0 0 16 16" version="1.1" width="30" fill="rgb(59 130 246)">
                        <path fill-rule="evenodd"  d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                        </svg>
                    </a>
             </li>
            </ul>
        </div>
    </aside>

    <main class="grid place-items-center">
        <svg class="animate-spin h-7 w-7 text-blue-500 absolute top-2/4 left-2/4 js-loadingIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <div class="game-container grid h-100 divide-y">
            <div class="canvas-container border-4 border-slate-200 rounded">
                <canvas id="myCanvas" width="50" height="50" ></canvas>
            </div>
            <div class="colors-container flex flex-wrap items-center justify-center gap-3 bg-slate-200 p-3 border-4 border-slate-200">
                <div class="color js-color -active" data-color="#000000" style="--colorBg:#000000;"></div>
                <div class="color js-color" data-color="#797979" style="--colorBg:#797979;"></div>
                <div class="color js-color" data-color="#ffffff" style="--colorBg:#ffffff;"></div>
                <div class="color js-color" data-color="#ff0000" style="--colorBg:#ff0000;"></div>
                <div class="color js-color" data-color="#ff8800" style="--colorBg:#ff8800;"></div>
                <div class="color js-color" data-color="#8d4b00" style="--colorBg:#8d4b00;"></div>
                <div class="color js-color" data-color="#fffb00" style="--colorBg:#fffb00;"></div>
                <div class="color js-color" data-color="#09ff00" style="--colorBg:#09ff00;"></div>
                <div class="color js-color" data-color="#00fff2" style="--colorBg:#00fff2;"></div>
                <div class="color js-color" data-color="#001aff" style="--colorBg:#001aff;"></div>
                <div class="color js-color" data-color="#a200ff" style="--colorBg:#a200ff;"></div>
                <div class="color js-color" data-color="#ff00f2" style="--colorBg:#ff00f2;"></div>
            </div>
        </div>
    </main>
    
    <div class="pixel_info js-pixelInfo shadow-md shadow-slate-900/10 bg-slate-800 text-white rounded whitespace-nowrap"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const loadingIcon = document.querySelector('.js-loadingIcon');
        const logoutBtn = document.querySelector('.js-logoutBtn');
        const loginBtn = document.querySelector('.js-loginBtn');
        const welcomeMsg = document.querySelector('.js-welcomeMsg');
        const isLogged = localStorage.getItem('rPlaceLoginJWT');
        const userName = localStorage.getItem('rPlaceUserName');
        const infoWindow = document.querySelector('.js-infoWindow');
        const closeMenu = document.querySelector('.js-hideMenu');
        const openMenu = document.querySelector('.js-openMenu');
        const sideMenu = document.querySelector('.js-sideMenu');


        closeMenu.addEventListener('click',() => {
            closeMenu.classList.add('hidden');
            openMenu.classList.remove('hidden');
            sideMenu.classList.add('-close')
        });
        openMenu.addEventListener('click',() =>{
            closeMenu.classList.remove('hidden');
            openMenu.classList.add('hidden');
            sideMenu.classList.remove('-close')
        });



        function getHeaderHeight(){
            const headerHeight = document.querySelector('.header').offsetHeight;
            document.documentElement.style.setProperty('--headerHeight',`${headerHeight}px`) 
        }

        function setWindowHeight(){
            const vh = window.innerHeight * 0.01;
             document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        window.addEventListener('resize', () => setWindowHeight());

        if(!isLogged){
            logoutBtn.remove();
        } else {
            welcomeMsg.innerHTML = `Hello <span class="font-semibold">${userName}</span>!`
            loginBtn.remove();
        }

        logoutBtn.addEventListener('click', () => {

           if( !isLogged ){
               return;
           }

           localStorage.removeItem('rPlaceLoginJWT');
           localStorage.removeItem('rPlaceUserName');
           window.location = '/';        
        });

        async function getPixels(){
            const request = await fetch('/pixels',{
                method: 'GET',
                headers: {"Content-Type": "application/json"}
            });

            const response = await request.json();

            return response;
        }

        let pixels;
        document.addEventListener('DOMContentLoaded', async () => {
 
            getHeaderHeight();
            setWindowHeight()

            pixels = await getPixels();
            
            for(pixel of pixels){
                paintCanvas(pixel);
            }

            loadingIcon.remove();

            if(isLogged){
                socket.emit('log', {'name': userName, action: 'login'});
            }
            
            socket.on('checkin', (data) => {
                const newSpan = document.createElement('span');
                let msg = '';
                switch (data.action) {
                    case 'login':
                        msg = 'Welcome <b>' + data.name + '</b>!';
                        break;
                    case 'paint':
                        msg = 'Nice <b style="color:'+data.color+'">pixel</b>, <b>' + data.name + '</b>!';

                        if(data.color === "#ffffff"){
                            msg = 'Nice <b style="padding:2px;background:black;color:'+data.color+'">pixel</b>, <b>' + data.name + '</b>!';
                        }

                        break;
                }

                newSpan.innerHTML = msg;
                infoWindow.appendChild(newSpan);
            });

        })

        const canvas = document.getElementById('myCanvas');
        const ctx = canvas.getContext('2d');

        function paintCanvas(pixel){
            ctx.fillStyle = pixel.color;
            ctx.fillRect(pixel.x, pixel.y, 1, 1);
        }


        const canvasZoomSize = canvas.offsetHeight;
        const canvasRealSize = Number(canvas.attributes.width.value);
        function convertPos(x, y) {
            const realX = Math.floor(canvasRealSize * x / canvasZoomSize);
            const realY = Math.floor(canvasRealSize * y / canvasZoomSize);
            return { x: realX, y: realY };
        }

        const pixelInfo = document.querySelector('.js-pixelInfo');
        const canvasCont = document.querySelector('.canvas-container');
        canvas.addEventListener('mousemove', evt => {
            const x = evt.pageX - evt.target.offsetLeft + canvasCont.scrollLeft;
            const y = evt.pageY - evt.target.offsetTop + canvasCont.scrollTop;
            
            const realPos = convertPos(x, y);
            
            const foundPixel = pixels.find(pix => pix.x === realPos.x && pix.y === realPos.y)

            if(
                foundPixel === undefined
            ){
                pixelInfo.style.display = 'none';
                return
            }

            pixelInfo.innerHTML = `by ${foundPixel.user_id.username}<br>at ${makeDateReadable(foundPixel.created_at)}`
            pixelInfo.style.top = evt.pageY + 'px';
            pixelInfo.style.left = evt.pageX + 'px';
            pixelInfo.style.display = 'block';
        });

        function makeDateReadable(date){
            date = new Date(date);

            let hours = addZeroBefore(date.getHours());
            let minutes = addZeroBefore(date.getMinutes());
            let day = addZeroBefore(date.getDate());
            let month = addZeroBefore(date.getMonth() + 1);
            let year = date.getFullYear();
            
            

            return `${hours}:${minutes} ${day}/${month}/${year}`
        }

        function addZeroBefore(n) {
            return (n < 10 ? '0' : '') + n;
        }

        canvas.addEventListener('mouseleave', () => {pixelInfo.style.display = 'none'});

        canvas.addEventListener('click', async (evt) => {
            const x = evt.pageX - evt.target.offsetLeft + canvasCont.scrollLeft;
            const y = evt.pageY - evt.target.offsetTop + canvasCont.scrollTop;
            const realPos = convertPos(x, y);
            
            let data = {
                "x":realPos.x,
                "y":realPos.y,
                "color": pickedColor
            }
            
            const request = await fetch('/pixels',{
                method: 'POST',
                headers: {
                    "Content-Type": "application/json",
                    "X-Auth-Token": localStorage.getItem('rPlaceLoginJWT')
                },
                body:JSON.stringify(data)
            });
            
            const response = await request.json();
            
            if(request.status !== 202){
                return showError(response.message);
            }
            
            data['created_at'] = new Date;
            data['user_id'] = {'username':userName}

            paintCanvas(data);
            socket.emit('pixel', data);
            socket.emit('log', {'name': userName, 'action': 'paint', 'color': data.color});
        });

        function showError(msg){
            let htmlToInject = `
                <div class="message_overlay js-msgOverlay">
                    <div class="message shadow-md">
                        ${msg}
                        <button class="js-closeMsg bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow-md shadow-blue-500/20">OK</button>
                    </div>
                </div>    
            `;

            document.querySelector('body').insertAdjacentHTML('beforeend', htmlToInject);

            document.querySelector('.js-closeMsg').addEventListener('click', () => {
                document.querySelector('.js-msgOverlay').remove();
            })
        }

        function updatePixel(data) {

            let existingPixel = -1;

            for(px in pixels){
                if(
                    pixels[px].x === data.x &&
                    pixels[px].y === data.y
                ){
                    existingPixel = px;
                    break;
                }   
            }

            if(existingPixel < 0){
                pixels.push(data)
            } else {
                pixels[existingPixel] = data;
            }
        }

        socket.on('pixel', (data) => {
            updatePixel(data);
            paintCanvas(data);
        });


        const userCount = document.querySelector('.js-userCount');
        socket.on('user count', (users) => {
            let msg = `üëÄ <b>${users}</b> people are watching...`

            if(users === 1){
                msg = `üòî You are the only one here`
            }

            userCount.innerHTML = msg;
        });

        const colorPicker = document.querySelectorAll('.js-color');
        let pickedColor = '#000000';

        for(tile of colorPicker){
            tile.addEventListener('click', (evt) => {

                if(!isLogged){
                    return showError('Please login to play');
                }

                if(evt.target.classList.contains('-active')) return;

                const activeTiles = document.querySelectorAll('.js-color.-active');

                for(activeTile of activeTiles){
                    activeTile.classList.remove('-active')
                }

                evt.target.classList.add('-active');

                pickedColor = evt.target.dataset.color ?? '#000000';
            })
        }

        // colorPicker.addEventListener('change', (evt) => {
        //     pickedColor = evt.target.value;
        // });
    </script>
</body>

</html>