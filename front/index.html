<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R_Place</title>
    <style>
        canvas {
            outline: 5px solid rgb(197, 197, 197);
            width: 800px;
            height: 800px;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            margin: 10px;
        }

        .colors{
            display: flex;
            gap:10px;
            margin-top:10px;
        }

        .color{
            height: 25px;
            width: 25px;
            background-color: var(--colorBg);
            cursor: pointer;
            border: 1px solid rgb(133, 133, 133)
        }

        .color.-active{
            transform:scale(1.2);
            box-shadow: 0 0 2px grey;
        }

        .pixel_info{
            position: fixed;
            padding: 10px;
            background: #000;
            color:white;
            transform: translateY(-15px);
            display: none;
        }
    </style>
</head>

<body>
    <header>
        <nav>
            <span class="js-welcomeMsg"></span>
            <button class="js-logoutBtn">Logout</button>
            <a href="/login" class="js-loginBtn">Login</a>
        </nav>

        <span class="js-userCount"></span>
    </header>
    <canvas id="myCanvas" width="50" height="50"></canvas>
    <div>
        <span for="picker">Pick your color:</span>
        <div class="colors">
            <div class="color js-color -active" data-color="#000000" style="--colorBg:#000000;"></div>
            <div class="color js-color" data-color="#797979" style="--colorBg:#797979;"></div>
            <div class="color js-color" data-color="#ffffff" style="--colorBg:#ffffff;"></div>
            <div class="color js-color" data-color="#ff0000" style="--colorBg:#ff0000;"></div>
            <div class="color js-color" data-color="#ff8800" style="--colorBg:#ff8800;"></div>
            <div class="color js-color" data-color="#8d4b00" style="--colorBg:#8d4b00;"></div>
            <div class="color js-color" data-color="#fffb00" style="--colorBg:#fffb00;"></div>
            <div class="color js-color" data-color="#09ff00" style="--colorBg:#09ff00;"></div>
            <div class="color js-color" data-color="#00fff2" style="--colorBg:#00fff2;"></div>
            <div class="color js-color" data-color="#001aff" style="--colorBg:#001aff;"></div>
            <div class="color js-color" data-color="#a200ff" style="--colorBg:#a200ff;"></div>
            <div class="color js-color" data-color="#ff00f2" style="--colorBg:#ff00f2;"></div>

        </div>
    </div>

    <div class="pixel_info js-pixelInfo"></div>


    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();

        const logoutBtn = document.querySelector('.js-logoutBtn');
        const loginBtn = document.querySelector('.js-loginBtn');
        const welcomeMsg = document.querySelector('.js-welcomeMsg');
        const isLogged = localStorage.getItem('rPlaceLoginJWT');
        const userName = localStorage.getItem('rPlaceUserName');

        
        if(!isLogged){
            logoutBtn.remove();
        } else {
            welcomeMsg.innerText = `Hello ${userName}!`
            loginBtn.remove();
        }

        logoutBtn.addEventListener('click', () => {

           if( !isLogged ){
               return;
           }

           localStorage.removeItem('rPlaceLoginJWT');
           localStorage.removeItem('rPlaceUserName');
           window.location = '/';        
        });

        async function getPixels(){
            const request = await fetch('/pixels',{
                method: 'GET',
                headers: {"Content-Type": "application/json"}
            });

            const response = await request.json();

            return response;
        }

        let pixels;
        document.addEventListener('DOMContentLoaded', async () => {

            pixels = await getPixels();
            
            for(pixel of pixels){
                paintCanvas(pixel);
            }

        })

        const canvas = document.getElementById('myCanvas');
        const ctx = canvas.getContext('2d');

        function paintCanvas(pixel){
            ctx.fillStyle = pixel.color;
            ctx.fillRect(pixel.x, pixel.y, 1, 1);
        }


        const canvasZoomSize = canvas.clientHeight;
        const canvasRealSize = Number(canvas.attributes.width.value);
        function convertPos(x, y) {
            const realX = Math.floor(canvasRealSize * x / canvasZoomSize);
            const realY = Math.floor(canvasRealSize * y / canvasZoomSize);
            return { x: realX, y: realY };
        }

        const pixelInfo = document.querySelector('.js-pixelInfo');
        canvas.addEventListener('mousemove', (evt) => {
            const x = evt.pageX - evt.target.offsetLeft;
            const y = evt.pageY - evt.target.offsetTop;
            const realPos = convertPos(x, y);
            
            const foundPixel = pixels.find(pix => pix.x === realPos.x && pix.y === realPos.y)

            if(
                foundPixel === undefined
            ){
                pixelInfo.style.display = 'none';
                return
            }

            pixelInfo.innerHTML = `by ${foundPixel.user_id.username}<br>at ${makeDateReadable(foundPixel.created_at)}`
            pixelInfo.style.top = y + 'px';
            pixelInfo.style.left = x + 'px';
            pixelInfo.style.display = 'block';
        });

        function makeDateReadable(date){
            date = new Date(date);

            return `${date.getHours()}:${date.getMinutes()} ${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`

        }

        canvas.addEventListener('mouseleave', () => pixelInfo.style.display = 'none');

        canvas.addEventListener('click', async (evt) => {
            const x = evt.pageX - evt.target.offsetLeft;
            const y = evt.pageY - evt.target.offsetTop;
            const realPos = convertPos(x, y);
            
            let data = {
                "x":realPos.x,
                "y":realPos.y,
                "color": pickedColor
            }
            
            const request = await fetch('/pixels',{
                method: 'POST',
                headers: {
                    "Content-Type": "application/json",
                    "X-Auth-Token": localStorage.getItem('rPlaceLoginJWT')
                },
                body:JSON.stringify(data)
            });
            
            const response = await request.json();
            
            if(request.status !== 202){
                console.error('Something went wrong, please try again later');
                return;
            }
            
            data['created_at'] = new Date;
            data['user_id'] = {'username':userName}

            paintCanvas(data);
            socket.emit('pixel', data);
        });

        function updatePixel(data) {

            let existingPixel = -1;

            for(px in pixels){
                if(
                    pixels[px].x === data.x &&
                    pixels[px].y === data.y
                ){
                    existingPixel = px;
                    break;
                }   
            }

            if(existingPixel < 0){
                pixels.push(data)
            } else {
                pixels[existingPixel] = data;
            }
        }

        socket.on('pixel', (data) => {
            updatePixel(data);
            paintCanvas(data);
        });

        const userCount = document.querySelector('.js-userCount');
        socket.on('user count', (users) => {
            let msg = `There are ${users} users online`

            if(users === 1){
                msg = `There is ${users} user online`
            }

            userCount.innerText = msg;
        });

        const colorPicker = document.querySelectorAll('.js-color');
        let pickedColor = '#000000';

        for(tile of colorPicker){
            tile.addEventListener('click', (evt) => {

                if(evt.target.classList.contains('-active')) return;

                const activeTiles = document.querySelectorAll('.js-color.-active');

                for(activeTile of activeTiles){
                    activeTile.classList.remove('-active')
                }

                evt.target.classList.add('-active');

                pickedColor = evt.target.dataset.color ?? '#000000';
            })
        }

        // colorPicker.addEventListener('change', (evt) => {
        //     pickedColor = evt.target.value;
        // });
    </script>
</body>

</html>