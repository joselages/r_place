<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R_Place</title>
    <style>
        :root{
            --headerHeight: 40px;
            --canvasSize: 800px;
        }


        .header{
            height: var(--headerHeight);
        }

        main{
            height: calc(100vh - var(--headerHeight));
        }

        canvas {
            width: var(--canvasSize);
            aspect-ratio: 1;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background-color: white;
        }

        .colors{
            display: flex;
            gap:10px;
        }

        .color{
            height: 25px;
            width: 25px;
            background-color: var(--colorBg);
            cursor: pointer;
            border: 1px solid rgb(191, 196, 204);
            transition: transform .1s ease;
        }

        .color.-active{
            transform:scale(1.2);
            box-shadow: 0 0 #0000,  0 0 #0000, 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .pixel_info{
            position: fixed;
            padding: 10px;
            transform: translateX(-50%) translateY(-130%);
            display: none;
        }

        .pixel_info::before{
            content: '';
            width: 15px;
            height: 15px;
            position: absolute;
            bottom: -7px;
            left: 50%;
            background-color: #1e293b;
            transform: translateX(-50%) rotate(45deg);
        }

        .message_overlay{
            position: fixed;
            inset: -1px;
            display: grid;
            place-items: center;
            background: rgba(8, 8, 8, 0.65);
        }

        .message{
            padding:40px 80px;
            background-color: white;
            display: flex;
            flex-direction: column;
            gap:15px
        }

        @media (max-width: 800px){
            main, .game-container{
                height: calc(100vh - 40px) !important;
            }
            .canvas-container{
                width: 100%;
                overflow: auto;
            }

        }
    </style>

    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="grid min-h-screen bg-slate-50 font-['Arial'] text-slate-600 overflow-x-hidden">
    <header class="header flex justify-between items-baseline py-2 px-4 bg-slate-200">
        <span class="js-userCount font-medium">Loading...</span>
        <nav>
            <span class="js-welcomeMsg mr-8"></span>
            <button class="js-logoutBtn bg-transparent text-blue-500 font font-semibold hover:opacity-50 py-1 px-2 border border-blue-500 rounded">Logout</button>
            <a href="/login" class="js-loginBtn text-blue-500 font-semibold hover:underline">Login</a>
        </nav>
    </header>
    <main class="grid place-items-center">
        <svg class="animate-spin h-7 w-7 text-blue-500 absolute top-2/4 left-2/4 js-loadingIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <div class="game-container grid h-100 divide-y">
            <div class="canvas-container border-4 border-slate-200 ">
                <canvas id="myCanvas" width="50" height="50" ></canvas>
            </div>
            <div class="colors-container flex flex-wrap items-center justify-center gap-3 bg-slate-200 p-3 border-4 border-slate-200">
                <div class="color js-color -active" data-color="#000000" style="--colorBg:#000000;"></div>
                <div class="color js-color" data-color="#797979" style="--colorBg:#797979;"></div>
                <div class="color js-color" data-color="#ffffff" style="--colorBg:#ffffff;"></div>
                <div class="color js-color" data-color="#ff0000" style="--colorBg:#ff0000;"></div>
                <div class="color js-color" data-color="#ff8800" style="--colorBg:#ff8800;"></div>
                <div class="color js-color" data-color="#8d4b00" style="--colorBg:#8d4b00;"></div>
                <div class="color js-color" data-color="#fffb00" style="--colorBg:#fffb00;"></div>
                <div class="color js-color" data-color="#09ff00" style="--colorBg:#09ff00;"></div>
                <div class="color js-color" data-color="#00fff2" style="--colorBg:#00fff2;"></div>
                <div class="color js-color" data-color="#001aff" style="--colorBg:#001aff;"></div>
                <div class="color js-color" data-color="#a200ff" style="--colorBg:#a200ff;"></div>
                <div class="color js-color" data-color="#ff00f2" style="--colorBg:#ff00f2;"></div>
            </div>
        </div>
    </main>
    
    <div class="pixel_info js-pixelInfo shadow-md shadow-slate-900/10 bg-slate-800 text-white rounded"></div>


    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const loadingIcon = document.querySelector('.js-loadingIcon');
        const logoutBtn = document.querySelector('.js-logoutBtn');
        const loginBtn = document.querySelector('.js-loginBtn');
        const welcomeMsg = document.querySelector('.js-welcomeMsg');
        const isLogged = localStorage.getItem('rPlaceLoginJWT');
        const userName = localStorage.getItem('rPlaceUserName');

        
        if(!isLogged){
            logoutBtn.remove();
        } else {
            welcomeMsg.innerHTML = `Hello <span class="font-semibold">${userName}</span>!`
            loginBtn.remove();
        }

        logoutBtn.addEventListener('click', () => {

           if( !isLogged ){
               return;
           }

           localStorage.removeItem('rPlaceLoginJWT');
           localStorage.removeItem('rPlaceUserName');
           window.location = '/';        
        });

        async function getPixels(){
            const request = await fetch('/pixels',{
                method: 'GET',
                headers: {"Content-Type": "application/json"}
            });

            const response = await request.json();

            return response;
        }

        let pixels;
        document.addEventListener('DOMContentLoaded', async () => {

            pixels = await getPixels();
            
            for(pixel of pixels){
                paintCanvas(pixel);
            }

            loadingIcon.remove();

        })

        const canvas = document.getElementById('myCanvas');
        const ctx = canvas.getContext('2d');

        function paintCanvas(pixel){
            ctx.fillStyle = pixel.color;
            ctx.fillRect(pixel.x, pixel.y, 1, 1);
        }


        const canvasZoomSize = canvas.offsetHeight;
        const canvasRealSize = Number(canvas.attributes.width.value);
        function convertPos(x, y) {
            const realX = Math.floor(canvasRealSize * x / canvasZoomSize);
            const realY = Math.floor(canvasRealSize * y / canvasZoomSize);
            return { x: realX, y: realY };
        }

        const pixelInfo = document.querySelector('.js-pixelInfo');
        canvas.addEventListener('mousemove', (evt) => {
            const x = evt.pageX - evt.target.offsetLeft;
            const y = evt.pageY - evt.target.offsetTop;
            
            const realPos = convertPos(x, y);
            
            const foundPixel = pixels.find(pix => pix.x === realPos.x && pix.y === realPos.y)

            if(
                foundPixel === undefined
            ){
                pixelInfo.style.display = 'none';
                return
            }

            pixelInfo.innerHTML = `by ${foundPixel.user_id.username}<br>at ${makeDateReadable(foundPixel.created_at)}`
            pixelInfo.style.top = evt.pageY + 'px';
            pixelInfo.style.left = evt.pageX + 'px';
            pixelInfo.style.display = 'block';
        });

        function makeDateReadable(date){
            date = new Date(date);

            let hours = addZeroBefore(date.getHours());
            let minutes = addZeroBefore(date.getMinutes());
            let day = addZeroBefore(date.getDate());
            let month = addZeroBefore(date.getMonth() + 1);
            let year = date.getFullYear();
            
            

            return `${hours}:${minutes} ${day}/${month}/${year}`
        }

        function addZeroBefore(n) {
            return (n < 10 ? '0' : '') + n;
        }

        canvas.addEventListener('mouseleave', () => {pixelInfo.style.display = 'none'});

        canvas.addEventListener('click', async (evt) => {
            const x = evt.pageX - evt.target.offsetLeft;
            const y = evt.pageY - evt.target.offsetTop;
            const realPos = convertPos(x, y);
            
            let data = {
                "x":realPos.x,
                "y":realPos.y,
                "color": pickedColor
            }
            
            const request = await fetch('/pixels',{
                method: 'POST',
                headers: {
                    "Content-Type": "application/json",
                    "X-Auth-Token": localStorage.getItem('rPlaceLoginJWT')
                },
                body:JSON.stringify(data)
            });
            
            const response = await request.json();
            
            if(request.status !== 202){
                return showError(response.message);
            }
            
            data['created_at'] = new Date;
            data['user_id'] = {'username':userName}

            paintCanvas(data);
            socket.emit('pixel', data);
        });

        function showError(msg){
            let htmlToInject = `
                <div class="message_overlay js-msgOverlay">
                    <div class="message shadow-md">
                        ${msg}
                        <button class="js-closeMsg bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow-md shadow-blue-500/20">OK</button>
                    </div>
                </div>    
            `;

            document.querySelector('body').insertAdjacentHTML('beforeend', htmlToInject);

            document.querySelector('.js-closeMsg').addEventListener('click', () => {
                document.querySelector('.js-msgOverlay').remove();
            })
        }

        function updatePixel(data) {

            let existingPixel = -1;

            for(px in pixels){
                if(
                    pixels[px].x === data.x &&
                    pixels[px].y === data.y
                ){
                    existingPixel = px;
                    break;
                }   
            }

            if(existingPixel < 0){
                pixels.push(data)
            } else {
                pixels[existingPixel] = data;
            }
        }

        socket.on('pixel', (data) => {
            updatePixel(data);
            paintCanvas(data);
        });

        const userCount = document.querySelector('.js-userCount');
        socket.on('user count', (users) => {
            let msg = `There are <b>${users}</b> users online`

            if(users === 1){
                msg = `There is <b>${users}</b> user online`
            }

            userCount.innerHTML = msg;
        });

        const colorPicker = document.querySelectorAll('.js-color');
        let pickedColor = '#000000';

        for(tile of colorPicker){
            tile.addEventListener('click', (evt) => {

                if(!isLogged){
                    return showError('Please login to play');
                }

                if(evt.target.classList.contains('-active')) return;

                const activeTiles = document.querySelectorAll('.js-color.-active');

                for(activeTile of activeTiles){
                    activeTile.classList.remove('-active')
                }

                evt.target.classList.add('-active');

                pickedColor = evt.target.dataset.color ?? '#000000';
            })
        }

        // colorPicker.addEventListener('change', (evt) => {
        //     pickedColor = evt.target.value;
        // });
    </script>
</body>

</html>