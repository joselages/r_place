<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R_Place</title>
    <style>
        canvas {
            outline: 5px solid rgb(197, 197, 197);
            width: 800px;
            height: 800px;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            margin: 10px;
        }

        .colors{
            display: flex;
            gap:10px
        }

        .colors span{
            height: 25px;
            width: 25px;
            background-color: var(--color);
            cursor: pointer;
        }

        .colors span.-active{
            transform:scale(1.2);
            box-shadow: 0 0 2px grey;
        }
    </style>
</head>

<body>
    <canvas id="myCanvas" width="50" height="50"></canvas>
    <div>
        <label for="picker">Pick your color:</label>
        <input type="color" id="color" name="picker">
    </div>
    <script>

        async function getPixels(){
            const request = await fetch('/pixels',{
                method: 'GET',
                headers: {"Content-Type": "application/json"}
            });

            const response = await request.json();

            return response;
        }

        document.addEventListener('DOMContentLoaded', async () => {

            const pixels = await getPixels();

            for(pixel of pixels){
                paintCanvas(pixel);
            }

        })

        const canvas = document.getElementById('myCanvas');
        const ctx = canvas.getContext('2d');

        function paintCanvas(pixel){
            ctx.fillStyle = pixel.color;
            ctx.fillRect(pixel.x, pixel.y, 1, 1);
        }


        const canvasZoomSize = canvas.clientHeight;
        const canvasRealSize = Number(canvas.attributes.width.value);
        function convertPos(x, y) {
            const realX = Math.floor(canvasRealSize * x / canvasZoomSize);
            const realY = Math.floor(canvasRealSize * y / canvasZoomSize);
            return { x: realX, y: realY };
        }

        canvas.addEventListener('click', async (evt) => {
            const x = evt.pageX - evt.target.offsetLeft;
            const y = evt.pageY - evt.target.offsetTop;
            const realPos = convertPos(x, y);
            
            let data = {
                "x":realPos.x,
                "y":realPos.y,
                "color": pickedColor
            }
            
            const request = await fetch('/pixels',{
                method: 'POST',
                headers: {
                    "Content-Type": "application/json",
                    "X-Auth-Token": localStorage.getItem('rPlaceLoginJWT')
                },
                body:JSON.stringify(data)
            });
            
            const response = await request.json();
            
            if(request.status !== 202){
                console.error('Something went wrong, please try again later');
                return;
            }
            
            paintCanvas(data);
        });



        const colorPicker = document.querySelector('#color');
        let pickedColor = '#000000';
        colorPicker.addEventListener('change', (evt) => {
            pickedColor = evt.target.value;
            console.log(pickedColor)
        });
    </script>
</body>

</html>