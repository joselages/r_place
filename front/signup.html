<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signup</title>

    <style>
        .message_overlay{
            position: fixed;
            inset: -1px;
            display: grid;
            place-items: center;
            background: rgba(8, 8, 8, 0.65);
        }

        .message{
            padding:40px 80px;
            background-color: white;
            display: flex;
            flex-direction: column;
            gap:15px
        }
    </style>
</head>
<body>
    <form class="js-signUpForm">
        <div>
            <label>
                Username
                <input type="text" name="username" minlength="5" maxlength="15" required>
            </label>
        </div>
        <div>
            <label>
                Email
                <input type="email" name="email" maxlength="252" required>
            </label>
        </div>
        <div>
            <label>
                Password
                <input type="password" name="password" minlength="8" maxlength="100" required>
            </label>
        </div>
        <div>
            <label>
                Repeat Password
                <input type="password" name="repeat_password" minlength="8" maxlength="100" required>
            </label>
        </div>
        <div>
            <button type="submit" name="submit">Submit</button>
        </div>
    </form>

    <script>
        const form = document.querySelector('.js-signUpForm');

        function validateUser(data){

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if(
                data['username'].length > 5 && data['username'].length < 16 &&
                emailRegex.test(data['email']) && 
                data['password'].length > 7 && data['password'].length < 101 &&
                data['password'] === data['repeat_password']
            ){
                return true;
            }

            return false;
        }

        form.addEventListener('submit', async (evt) => {
            evt.preventDefault();
            
            let data = {};

            for(input of evt.target.elements){
                data[input.name] = input.value;
            }

            if(validateUser(data) === false){
                return console.log('error');
            }

            delete data['repeat_password'];
            delete data['submit'];

            const request = await fetch('/users',{
                method: 'POST',
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(data)
            });

            const response = await request.json();

            if(request.status !== 202){
                return showError(response.message)
            }

            showError('You can login now!')
            
        });

        
        function showError(msg){
            let htmlToInject = `
                <div class="message_overlay js-msgOverlay">
                    <div class="message">
                        ${msg}
                        <button class="js-closeMsg">OK</button>
                    </div>
                </div>    
            `;

            document.querySelector('body').insertAdjacentHTML('beforeend', htmlToInject);

            document.querySelector('.js-closeMsg').addEventListener('click', () => {
                document.querySelector('.js-msgOverlay').remove();
            })
        }
    </script>
</body>
</html>